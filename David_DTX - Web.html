<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>David DTX | Oficial</title>
  <meta name="description" content="Página oficial de David DTX — DJ residente. Música, galería, agenda y próximos eventos.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;500;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold:#dd9933;
      --bg:#000;
      --muted:rgba(255,255,255,0.86);
      --glass: rgba(255,255,255,0.03);
      --accent:#0693e3;
      --max-width:1100px;
    }
    [data-theme='light']{ --bg:#f7f7f8; --muted:#222; --glass: rgba(0,0,0,0.04); background:#f7f7f8; color:var(--muted); }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Roboto,Arial;background:var(--bg);color:var(--muted)}
    header{position:fixed;left:0;right:0;top:0;z-index:60;backdrop-filter: blur(6px);background:linear-gradient(180deg, rgba(0,0,0,0.22), transparent)}
    .nav{max-width:var(--max-width);margin:0 auto;padding:12px 18px;display:flex;align-items:center;justify-content:space-between}
    .logo{display:flex;align-items:center;gap:12px}
    .mark{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--gold),#b86f13);display:flex;align-items:center;justify-content:center;font-weight:800;color:#111}
    nav a{color:var(--muted);text-decoration:none;margin-left:16px}

    .hero{height:72vh;min-height:420px;background-image:url('https://images.pexels.com/photos/164879/pexels-photo-164879.jpeg');background-size:cover;background-position:center;display:flex;align-items:center;justify-content:center;position:relative}
    .hero::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg, rgba(0,0,0,0.3), rgba(0,0,0,0.6));}
    .hero-inner{text-align:center;z-index:2}
    .hero h1{font-family:Oswald;font-size:4.2rem;color:var(--gold);margin:0}
    .hero p{color:var(--muted);margin-top:10px}

    main{max-width:var(--max-width);margin:40px auto;padding:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 30px rgba(0,0,0,0.5)}

    .row{display:flex;flex-wrap:wrap;gap:18px}
    .col{flex:1 1 320px}

    .gallery-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .gallery-grid img{width:100%;height:150px;object-fit:cover;border-radius:8px;cursor:pointer}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.88);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .18s}
    .modal.open{opacity:1;pointer-events:auto}
    .modal img{max-width:92%;max-height:84%;border-radius:8px}

    .events-list{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .event{display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.03)}
    .date{width:64px;height:64px;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--gold),#b86f13);color:#111;font-weight:800}

    .player{display:flex;flex-direction:column;gap:12px;padding:12px;border-radius:10px}
    .controls{display:flex;gap:10px;align-items:center}
    .play-btn{background:var(--gold);border:none;padding:9px 12px;border-radius:8px;font-weight:700;cursor:pointer}
    .play-btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .progress{height:8px;background:rgba(255,255,255,0.06);border-radius:8px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--gold),#ffd07a);width:0%}

    .vis-wrap{background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));padding:8px;border-radius:8px}
    canvas#audioVis{width:100%;height:96px;display:block}

    .map{width:100%;height:220px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}

    footer{padding:24px;text-align:center;color:rgba(255,255,255,0.6)}

    @media (max-width:980px){.gallery-grid{grid-template-columns:repeat(2,1fr)}.events-list{grid-template-columns:1fr}.hero h1{font-size:3rem}}
    @media (max-width:520px){.gallery-grid{grid-template-columns:repeat(1,1fr)}.hero{height:50vh}.nav{padding:10px}}
  </style>
</head>
<body>

<header>
  <div class="nav">
    <div class="logo">
      <div class="mark">DD</div>
      <div style="margin-left:6px">
        <div style="font-family:Oswald;font-weight:700">David DTX</div>
        <div style="font-size:12px;color:var(--muted)">DJ · Save The Rave</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:12px">
      <nav>
        <a href="#about">Sobre</a>
        <a href="#gallery">Galería</a>
        <a href="#agenda">Agenda</a>
        <a href="#music">Música</a>
      </nav>
      <button id="themeToggle" class="play-btn ghost" title="Modo claro/oscuro">Tema</button>
    </div>
  </div>
</header>

<div class="hero">
  <div class="hero-inner">
    <h1>DAVID DTX</h1>
    <p>Sesiones intensas — Hard / Makina / Hardcore</p>
  </div>
</div>

<main>
  <section id="about" class="card">
    <h3 style="color:var(--gold)">Sobre David DTX</h3>
    <p>Valenciano. DJ desde finales de los 90; residente en Discoteca Chocolate desde 2004.</p>
  </section>

  <div style="height:18px"></div>

  <div class="row">
    <div class="col card">
      <h3 style="color:var(--gold)">Galería</h3>
      <div id="gallery" class="gallery-grid">
        <img src="https://images.pexels.com/photos/167636/pexels-photo-167636.jpeg" data-full="https://images.pexels.com/photos/167636/pexels-photo-167636.jpeg">
        <img src="https://images.pexels.com/photos/164879/pexels-photo-164879.jpeg" data-full="https://images.pexels.com/photos/164879/pexels-photo-164879.jpeg">
        <img src="https://images.pexels.com/photos/1680172/pexels-photo-1680172.jpeg" data-full="https://images.pexels.com/photos/1680172/pexels-photo-1680172.jpeg">
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <input type="file" id="imgUpload" accept="image/*">
        <button id="clearGallery" class="play-btn ghost">Limpiar galería</button>
      </div>
    </div>

    <div class="col card">
      <h3 style="color:var(--gold)">Agenda & Eventos</h3>

      <form id="eventForm" style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;margin-bottom:12px">
        <input id="evtTitle" placeholder="Título del evento" required style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">
        <input id="evtDate" type="date" required style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">
        <input id="evtPlace" placeholder="Lugar (opcional)" style="grid-column:1/span2;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">
        <div style="display:flex;gap:8px">
          <button class="play-btn" type="submit">Añadir</button>
          <button type="button" id="exportICal" class="play-btn ghost">Exportar iCal</button>
        </div>
      </form>

      <div style="display:flex;gap:8px;margin-bottom:10px">
        <input type="file" id="icsUpload" accept=".ics">
        <button id="loadSampleEvents" class="play-btn ghost">Cargar muestra</button>
        <button id="clearEvents" class="play-btn ghost">Limpiar eventos</button>
      </div>

      <div id="eventsList" class="events-list"></div>
    </div>
  </div>

  <div style="height:18px"></div>

  <section id="music" class="card">
    <h3 style="color:var(--gold)">Música — Reproductor</h3>

    <div class="player">
      <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap">
        <div>
          <div id="currentTitle" style="font-weight:700">DAVID DTX — Live @ Chocolate</div>
          <div id="currentAuthor" style="font-size:13px;color:rgba(255,255,255,0.7)">Set completo</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="prevBtn" class="play-btn ghost">Prev</button>
          <button id="playPause" class="play-btn">Play</button>
          <button id="nextBtn" class="play-btn ghost">Next</button>
          <button id="muteBtn" class="play-btn ghost">Mute</button>
        </div>
      </div>

      <div class="progress" style="margin-top:8px"><i id="progBar"></i></div>

      <div class="controls" style="justify-content:space-between;margin-top:8px;flex-wrap:wrap">
        <div style="display:flex;gap:8px;align-items:center">
          <select id="playlistSel" style="background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--muted)"></select>
          <a id="downloadTrack" class="play-btn ghost" href="#" download>Descargar</a>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <label class="small">Vol</label>
          <input id="vol" type="range" min="0" max="1" step="0.01" value="0.85">
          <label class="play-btn ghost" style="cursor:pointer">
            Subir MP3
            <input type="file" id="audioUpload" accept="audio/mpeg" style="display:none">
          </label>
        </div>
      </div>

      <div class="vis-wrap" style="margin-top:10px"><canvas id="audioVis"></canvas></div>

      <audio id="audioPlayer" preload="metadata"></audio>
    </div>
  </section>

  <div style="height:18px"></div>

  <div class="row">
    <div class="col card">
      <h3 style="color:var(--gold)">Ubicación</h3>
      <div class="map"><iframe title="Mapa" src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3120.0000000000005!2d-0.000000!3d39.469000!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zNDnCsDI4JzA0LjAiTiAwwrAwMCcwMC4wIlc!5e0!3m2!1ses!2ses!4v1590000000000!5m2!1ses!2ses" style="border:0;width:100%;height:100%"></iframe></div>
    </div>
    <div class="col card">
      <h3 style="color:var(--gold)">Contacto & Redes</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <a href="https://www.instagram.com/david_dtx" target="_blank" class="play-btn ghost">Instagram</a>
        <a href="https://es-la.facebook.com/daviddtx11" target="_blank" class="play-btn ghost">Facebook</a>
      </div>
    </div>
  </div>

</main>

<div id="lightbox" class="modal"><img src="" alt="preview"></div>

<footer>© David DTX · Hecho con ❤️</footer>

<script>
// ---------- Utilities (localStorage) ----------
const LS = { get(k,fb){try{return JSON.parse(localStorage.getItem(k))||fb}catch(e){return fb}}, set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){console.warn(e)}}, remove(k){localStorage.removeItem(k)} };

// ---------- THEME (dark/light) ----------
const themeToggle=document.getElementById('themeToggle');
function applyTheme(t){ if(t==='light'){document.documentElement.setAttribute('data-theme','light'); LS.set('ddtx_theme','light')} else {document.documentElement.removeAttribute('data-theme'); LS.set('ddtx_theme','dark')} }
const savedTheme=LS.get('ddtx_theme','dark'); applyTheme(savedTheme);
themeToggle.addEventListener('click', ()=>{ const cur = LS.get('ddtx_theme','dark'); applyTheme(cur==='dark'?'light':'dark') });

// ---------- GALLERY (simple) ----------
const galleryEl=document.getElementById('gallery'); const imgUpload=document.getElementById('imgUpload'); const clearGalleryBtn=document.getElementById('clearGallery');
function renderGallery(){ galleryEl.innerHTML=''; const imgs=LS.get('ddtx_gallery',["https://images.pexels.com/photos/167636/pexels-photo-167636.jpeg","https://images.pexels.com/photos/164879/pexels-photo-164879.jpeg","https://images.pexels.com/photos/1680172/pexels-photo-1680172.jpeg"]); imgs.forEach(src=>{ const img=document.createElement('img'); img.src=src; img.dataset.full=src; img.tabIndex=0; img.addEventListener('click',()=>openLightbox(src)); img.addEventListener('keydown',e=>{if(e.key==='Enter')openLightbox(src)}); galleryEl.appendChild(img); }); }
function openLightbox(src){ const lb=document.getElementById('lightbox'); lb.querySelector('img').src=src; lb.classList.add('open'); }
imgUpload.addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const imgs=LS.get('ddtx_gallery',[]); imgs.unshift(r.result); if(imgs.length>30) imgs.length=30; LS.set('ddtx_gallery',imgs); renderGallery(); }; r.readAsDataURL(f); imgUpload.value=''; });
clearGalleryBtn.addEventListener('click', ()=>{ if(confirm('Borrar galería?')){ LS.remove('ddtx_gallery'); renderGallery(); } });
renderGallery(); document.getElementById('lightbox').addEventListener('click', e=>{ if(e.target===document.getElementById('lightbox')) document.getElementById('lightbox').classList.remove('open'); });

// ---------- EVENTS (CRUD + iCal import/export) ----------
let events = LS.get('ddtx_events',[]);
const eventForm=document.getElementById('eventForm'); const evtTitle=document.getElementById('evtTitle'); const evtDate=document.getElementById('evtDate'); const evtPlace=document.getElementById('evtPlace'); const eventsList=document.getElementById('eventsList'); const clearEvents=document.getElementById('clearEvents'); const loadSampleEvents=document.getElementById('loadSampleEvents'); const exportICalBtn=document.getElementById('exportICal'); const icsUpload=document.getElementById('icsUpload');
function uid(){return Math.random().toString(36).slice(2,9)}
function renderEvents(){ eventsList.innerHTML=''; events.sort((a,b)=>new Date(a.date)-new Date(b.date)); events.forEach(ev=>{ const w=document.createElement('div'); w.className='event'; const d=document.createElement('div'); d.className='date'; const dt=new Date(ev.date); d.innerHTML=`<div style=\"font-size:16px\">${String(dt.getDate()).padStart(2,'0')}</div><div style=\"font-size:12px\">${dt.toLocaleString('es-ES',{month:'short'})}</div>`; const info=document.createElement('div'); info.innerHTML=`<h4>${ev.title}</h4><p>${ev.place||''} · ${dt.toLocaleString()}</p>`; const actions=document.createElement('div'); actions.style.marginLeft='auto'; actions.style.display='flex'; actions.style.gap='8px'; const edit=document.createElement('button'); edit.className='play-btn ghost'; edit.textContent='Editar'; edit.addEventListener('click',()=>{ evtTitle.value=ev.title; evtDate.value=ev.date; evtPlace.value=ev.place; events=events.filter(x=>x.id!==ev.id); LS.set('ddtx_events',events); renderEvents(); }); const del=document.createElement('button'); del.className='play-btn ghost'; del.textContent='Borrar'; del.addEventListener('click',()=>{ if(confirm('Borrar evento?')){ events=events.filter(x=>x.id!==ev.id); LS.set('ddtx_events',events); renderEvents(); } }); const ical=document.createElement('button'); ical.className='play-btn ghost'; ical.textContent='iCal'; ical.addEventListener('click',()=>downloadEventICal(ev)); actions.appendChild(edit); actions.appendChild(del); actions.appendChild(ical); w.appendChild(d); w.appendChild(info); w.appendChild(actions); eventsList.appendChild(w); }); }
function escapeICal(s){ return (s||'').replace(/\n/g,'\\n').replace(/,/g,'\\,') }
function exportICal(){ const header=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//DavidDTX//Agenda//ES'].join('\\r\\n'); const footer='\\r\\nEND:VCALENDAR'; const items=events.map(ev=>{ const dt=new Date(ev.date); const dtStart=dt.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z'; return ['BEGIN:VEVENT',`UID:${ev.id}@ddtx.local`,`DTSTAMP:${(new Date()).toISOString().replace(/[-:]/g,'').split('.')[0]}Z`,`DTSTART:${dtStart}`,`SUMMARY:${escapeICal(ev.title)}`,`LOCATION:${escapeICal(ev.place||'')}`,'END:VEVENT'].join('\\r\\n'); }).join('\\r\\n'); const ics=header+'\\r\\n'+items+footer; const blob=new Blob([ics],{type:'text/calendar;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ddtx_events.ics'; a.click(); URL.revokeObjectURL(url); }
exportICalBtn.addEventListener('click', exportICal);

eventForm.addEventListener('submit', e=>{ e.preventDefault(); const title=evtTitle.value.trim(); const date=evtDate.value; const place=evtPlace.value.trim(); if(!title||!date){ alert('Rellena título y fecha'); return; } events.push({id:uid(),title,date,place}); LS.set('ddtx_events',events); evtTitle.value=''; evtDate.value=''; evtPlace.value=''; renderEvents(); });
clearEvents.addEventListener('click', ()=>{ if(confirm('Eliminar todos los eventos?')){ events=[]; LS.set('ddtx_events',events); renderEvents(); } });
loadSampleEvents.addEventListener('click', ()=>{ events=[{id:uid(),title:'Chocolate — 42 Aniversario',date:new Date().toISOString().slice(0,10),place:'Discoteca Chocolate'},{id:uid(),title:'Save The Rave — Showcase',date:new Date(Date.now()+1000*60*60*24*10).toISOString().slice(0,10),place:'Club X'}]; LS.set('ddtx_events',events); renderEvents(); });

// ICS Import (simple parser)
icsUpload.addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const txt=r.result; const vevents=txt.split(/BEGIN:VEVENT/gi).slice(1); vevents.forEach(v=>{ const uidMatch=v.match(/UID:(.+)/i); const dtMatch=v.match(/DTSTART(?:;[^:]+)?:([0-9TZ]+)/i); const titleMatch=v.match(/SUMMARY:(.+)/i); const locMatch=v.match(/LOCATION:(.+)/i); if(dtMatch&&titleMatch){ const dateStr=dtMatch[1]; // try parse YYYYMMDD or YYYYMMDDTHHMMSSZ
    let iso=dateStr; if(/^\d{8}$/.test(dateStr)){ iso=dateStr.slice(0,4)+'-'+dateStr.slice(4,6)+'-'+dateStr.slice(6,8); } else if(/^\d{8}T\d{6}Z$/.test(dateStr)){ iso=dateStr.slice(0,4)+'-'+dateStr.slice(4,6)+'-'+dateStr.slice(6,8)+'T'+dateStr.slice(9,15)+'Z'; }
    const ev={ id: uidMatch?uidMatch[1].trim():uid(), title: (titleMatch[1]||'Evento').trim(), date: new Date(iso).toISOString().slice(0,10), place: locMatch?locMatch[1].trim():'' };
    events.push(ev);
  }}); LS.set('ddtx_events',events); renderEvents(); alert('Importación ICS completada'); }; r.readAsText(f); icsUpload.value=''; });

renderEvents();

// ---------- AUDIO: Playlist, IndexedDB uploads, volume/mute, visualizer ----------
const audio=document.getElementById('audioPlayer'); const playPause=document.getElementById('playPause'); const prevBtn=document.getElementById('prevBtn'); const nextBtn=document.getElementById('nextBtn'); const muteBtn=document.getElementById('muteBtn'); const progBar=document.getElementById('progBar'); const playlistSel=document.getElementById('playlistSel'); const downloadTrack=document.getElementById('downloadTrack'); const vol=document.getElementById('vol'); const audioUpload=document.getElementById('audioUpload');

let tracks = LS.get('ddtx_tracks',[
    {src:'https://files.freemusicarchive.org/storage-freemusicarchive-org/music/ccCommunity/Various_Artists/Hardcore_Mixes/Various_Artists_-_Hardcore_Mix.mp3',
    title:'DAVID DTX — Live @ Chocolate'},
    {src:'audio/Chocolate_-_All_Night_Long_by_David_DTX_-_Febrero_2025.mp3', title:'All Night Long'}
]);
function populatePlaylist(){ playlistSel.innerHTML=''; tracks.forEach((t,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=t.title; playlistSel.appendChild(o); }); saveTracksToLS(); }
function saveTracksToLS(){ LS.set('ddtx_tracks',tracks); }
populatePlaylist();

let cur = 0;
function loadTrack(i){ cur=i; const t=tracks[i]; audio.src = t.src; document.getElementById('currentTitle').textContent = t.title; playlistSel.value=i; downloadTrack.href = t.src; }
loadTrack(0);

playPause.addEventListener('click', ()=>{ if(audio.paused){ audio.play(); playPause.textContent='Pause'; }else{ audio.pause(); playPause.textContent='Play'; } });
prevBtn.addEventListener('click', ()=>{ cur=(cur-1+tracks.length)%tracks.length; loadTrack(cur); audio.play(); playPause.textContent='Pause'; });
nextBtn.addEventListener('click', ()=>{ cur=(cur+1)%tracks.length; loadTrack(cur); audio.play(); playPause.textContent='Pause'; });
playlistSel.addEventListener('change', e=>{ loadTrack(parseInt(e.target.value)); audio.play(); playPause.textContent='Pause'; });

// volume & mute
audio.volume = parseFloat(vol.value);
vol.addEventListener('input', ()=>{ audio.volume = parseFloat(vol.value); LS.set('ddtx_volume',audio.volume); if(audio.volume>0) muteBtn.textContent='Mute'; });
muteBtn.addEventListener('click', ()=>{ if(audio.muted){ audio.muted=false; muteBtn.textContent='Mute'; vol.value = audio.volume; } else { audio.muted=true; muteBtn.textContent='Unmute'; vol.value=0; } });

// progress
audio.addEventListener('timeupdate', ()=>{ const pct = (audio.currentTime / (audio.duration||1)) * 100; progBar.style.width = pct + '%'; });

// ---------- IndexedDB for audio uploads (store File blobs) ----------
let db; const req = indexedDB.open('DDTX_AudioDB',1);
req.onupgradeneeded = e=>{ db = e.target.result; if(!db.objectStoreNames.contains('tracks')) db.createObjectStore('tracks',{keyPath:'id',autoIncrement:true}); };
req.onsuccess = e=>{ db = e.target.result; loadStoredTracks(); };
function loadStoredTracks(){ const tx = db.transaction('tracks','readonly'); tx.objectStore('tracks').getAll().onsuccess = ev=>{ const stored = ev.target.result; stored.forEach(s=>{ const url = URL.createObjectURL(s.file); tracks.push({src:url,title:s.title}); }); populatePlaylist(); }; }

audioUpload.addEventListener('change', e=>{ const file = e.target.files[0]; if(!file) return; const title = file.name.replace(/\.mp3$/i,''); const tx = db.transaction('tracks','readwrite'); tx.objectStore('tracks').add({file,title}); tracks.push({src:URL.createObjectURL(file),title}); populatePlaylist(); alert('MP3 subido y añadido al playlist'); audioUpload.value=''; });

// ---------- Visualizer (bars + spectrum) ----------
const canvas = document.getElementById('audioVis'); const ctx = canvas.getContext('2d'); let audioCtx, analyser, bufferLength, dataArray, animationId;
function setupVisualizer(){ if(audioCtx) return; audioCtx = new (window.AudioContext || window.webkitAudioContext)(); analyser = audioCtx.createAnalyser(); analyser.fftSize = 512; bufferLength = analyser.frequencyBinCount; dataArray = new Uint8Array(bufferLength); const source = audioCtx.createMediaElementSource(audio); source.connect(analyser); analyser.connect(audioCtx.destination); resizeCanvas(); window.addEventListener('resize', resizeCanvas); renderVis(); }
function resizeCanvas(){ const rect = canvas.getBoundingClientRect(); canvas.width = rect.width * devicePixelRatio; canvas.height = rect.height * devicePixelRatio; ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0); }
function renderVis(){ analyser.getByteFrequencyData(dataArray); ctx.clearRect(0,0,canvas.width,canvas.height); const w = canvas.width / devicePixelRatio; const h = canvas.height / devicePixelRatio; const barWidth = (w / bufferLength) * 1.6; let x=0; for(let i=0;i<bufferLength;i++){ const v = dataArray[i]/255; const barH = v * h; const grad = ctx.createLinearGradient(0,0,0,h); grad.addColorStop(0,'rgba(221,153,51,0.9)'); grad.addColorStop(1,'rgba(107,224,255,0.7)'); ctx.fillStyle = grad; ctx.fillRect(x, h-barH, barWidth, barH); x += barWidth + 1; } animationId = requestAnimationFrame(renderVis); }
audio.addEventListener('play', ()=>{ try{ setupVisualizer(); audioCtx.resume(); }catch(e){} });

// ---------- Accessibility & misc ----------
document.addEventListener('keydown', e=>{ if(e.key==='m') document.querySelector('main').scrollIntoView({behavior:'smooth'}); });

// Save volume on unload
window.addEventListener('beforeunload', ()=>{ LS.set('ddtx_volume', audio.volume); LS.set('ddtx_tracks', tracks); });

// Restore saved volume
const savedVol = LS.get('ddtx_volume',0.85); vol.value = savedVol; audio.volume = savedVol;

console.log('David DTX — página cargada con funciones: ICS import, audio upload (IndexedDB), visualizer, volume/mute, theme toggle.');
</script>

</body>
</html>